angular.module("identityHub",[]),angular.module("identityHub").provider("identityService",function(){var a=this;return this.config=function(b){a.oauthParameters=b;var c=a.oauthParameters.baseUrl;if("string"!=typeof c)throw{error:"The baseUrl is required."};c=c.trim(),"/"===c[c.length-1]&&(c=c.substring(0,c.length-1)),a.oauthParameters.baseUrl=c},this.$get=["$http","$q","$interval","$window",function(a,b,c,d){function e(a){("?"===a[0]||"#"===a[0])&&(a=a.substr(1,a.length-1)),"/"===a[0]&&(a=a.substr(1,a.length-1));var b=a.split("&"),c=[];if(b&&b.length>0)for(var d=0;d<b.length;d++){var e=b[d].split("=");2===e.length&&(c[e[0]]=decodeURIComponent(e[1]))}return c}var f=this,g=[],h=this,i={signIn:function(a){var b=f.oauthParameters.baseUrl+"/oauth2/v1/auth?response_type=token&client_id="+encodeURIComponent(f.oauthParameters.clientId)+"&redirect_uri="+encodeURIComponent(f.oauthParameters.redirectUri);void 0!==f.oauthParameters.scopes&&(b+="&scope="+encodeURIComponent(f.oauthParameters.scopes)),b+=a&&""!==a?"&state="+encodeURIComponent(a):"&state="+encodeURIComponent(d.location.hash),f.oauthParameters.popup?f.authenticationBroker({url:b,redirectUri:h.oauthParameters.redirectUri,width:600,height:500}).then(function(a){h.parseResponse(a.hash)}):d.location.href=b},signOut:function(){var c=b.defer(),d=f.getToken();return sessionStorage.removeItem("access_token"),i.principal.isAuthenticated=!1,i.principal.isVerified=!1,i.principal.identity=null,a({method:"POST",url:f.oauthParameters.baseUrl+"/oauth2/v1/revoke",data:$.param({token:d.access_token,token_type_hint:"access_token",client_id:f.oauthParameters.clientId}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){c.resolve(a)}).error(function(a){c.reject(a)}),c.promise},getProfile:function(){var c=b.defer(),d=f.getToken();return a.get(f.oauthParameters.baseUrl+"/api/identity/v1/",{headers:{Authorization:"Bearer "+d.access_token}}).success(function(a){i.principal.identity=a,c.resolve(a)}).error(function(a){c.reject(a)}),c.promise},getFriends:function(){var c=b.defer(),d=f.getToken();return a.get(f.oauthParameters.baseUrl+"/api/identity/v1/friends",{headers:{Authorization:"Bearer "+d.access_token}}).success(function(a){c.resolve(a)}).error(function(a){c.reject(a)}),c.promise},getAccounts:function(){var c=b.defer(),d=f.getToken();return a.get(f.oauthParameters.baseUrl+"/api/identity/v1/accounts",{headers:{Authorization:"Bearer "+d.access_token}}).success(function(a){c.resolve(a)}).error(function(a){c.reject(a)}),c.promise},requireTwoFactorAuthentication:function(){var c=b.defer(),d=f.getToken();return i.principal.isVerified?(c.resolve(!0),c.promise):(a.get(f.oauthParameters.baseUrl+"/oauth2/v1/verify",{headers:{Authorization:"Bearer "+d.access_token}}).success(function(a){if(a&&a.resource_owner_identity_verified)i.principal.isVerified=!0,c.resolve(!0);else{var b=f.oauthParameters.baseUrl+"/Authenticate/PerformTwoFactorAuthenticationVerification?accessToken="+d.access_token+"&clientId="+f.oauthParameters.clientId+"&returnUrl="+encodeURIComponent(f.oauthParameters.redirectUri);f.authenticationBroker({url:b,redirectUri:f.oauthParameters.redirectUri,width:600,height:500}).then(function(a){var b="resource_owner_identity_verified=",d=a.href.indexOf(b);if(-1!=d&&a.href.length>=d+(b.length+1)){var e="1"==a.href[d+b.length];i.principal.isVerified=e,c.resolve(e)}else c.resolve(!1)})}}).error(function(a){c.reject(a)}),c.promise)},addAccount:function(a){var c=b.defer(),d=f.getToken();return f.authenticationBroker({url:a.signInUrl+"?access_token="+d.access_token+"&returnurl="+encodeURIComponent(f.oauthParameters.redirectUri),redirectUri:f.oauthParameters.redirectUri,width:600,height:500}).then(function(){c.resolve()}),c.promise},principal:{isAuthenticated:!1,isVerified:!1,token:null,identity:null}};return this.authenticationBroker=function(a){var e=b.defer(),f=d.screenX+(d.outerWidth-a.width)/2,g=d.screenY+(d.outerHeight-a.height)/2,h="status=0,resizable=0,scrollbars=1,location=0,toolbar=0,menubar=0,titlebar=0,left= "+f+",top="+g+",height="+a.height+",width="+a.width,i=d.open(a.url,"Authenticate",h),j=c(function(){try{if(i.location.href.indexOf(a.redirectUri)>=0){var b={href:i.location.href,hash:i.location.hash,search:i.location.search};setTimeout(function(){e.resolve(b)},1e3),i.close(),i=null,c.cancel(j)}}catch(d){}},1e3);return e.promise},this.getToken=function(){var a,b=(new Date).getTime();if(i.principal&&void 0!==i.principal){if(a=i.principal.token,a&&a.access_token&&a.expiry>b)return a}else if(a=JSON.parse(sessionStorage.getItem("access_token")),a&&a.access_token&&a.expiry>b)return a;i.principal.token=null,i.principal.isAuthenticated=!1,sessionStorage.removeItem("access_token"),f.oauthParameters.manualSignIn||i.signIn()},this.setToken=function(a){return a&&a.access_token&&""!==a.access_token&&(i.principal.token={access_token:a.access_token,expiry:(new Date).getTime()+1e3*a.expires_in,scope:a.scope},i.principal.isAuthenticated=!0,i.principal.isVerified="1"===a.resource_owner_identity_verified,sessionStorage.setItem("access_token",i.principal.token)),null},this.parseResponse=function(a){var b;if(a&&""!==a||(a=window.location.hash),a&&""!==a&&(b=e(a),f.setToken(b),i.principal.isAuthenticated)){i.getProfile();var c=b.state;return void(window.location.hash=c&&""!==c?c:"")}f.oauthParameters.manualSignIn||i.signIn()},g.invalid_request="The request is missing a required parameter, includes an invalid parameter value, includes a parameter more than once, or is otherwise malformed.",g.invalid_client="Invalid client",g.invalid_grant="Invalid grant",g.invalid_token="The token is invlaid.",g.unauthorized_client="The client is not authorized to request an access token using this method.",g.unsupported_grant_type="Unsupported grant type.",g.unsupported_response_type="The authorization server does not support obtaining an access token using this method.",g.invalid_scope="The requested scope is invalid, unknown, or malformed.",g.access_denied="The resource owner or authorization server denied the request.",g.server_error="The authorization server encountered an unexpected condition that prevented it from fulfilling the request. (This error code is needed because a 500 Internal Server Error HTTP status code cannot be returned to the client via an HTTP redirect.)",g.unsupported_token_type="The authorization server does not support the revocation of the presented token type.  That is, the client tried to revoke an access token on a server not supporting this feature.",this.parseResponse(),i}],this});